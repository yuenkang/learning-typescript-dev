# ============================================
# ğŸ“– å­¦ä¹ ç‚¹ï¼šå¤šé˜¶æ®µ Docker æ„å»ºï¼ˆMulti-stage Buildï¼‰
# ============================================
# åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
#   1. build é˜¶æ®µï¼šå®‰è£…ä¾èµ–ã€ç¼–è¯‘ TypeScript
#   2. production é˜¶æ®µï¼šåªå¤åˆ¶è¿è¡Œæ—¶éœ€è¦çš„æ–‡ä»¶
# è¿™æ ·æœ€ç»ˆé•œåƒæ›´å°ã€æ›´å®‰å…¨

# ---------- ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º ----------
FROM node:22-alpine AS build

WORKDIR /app

# ğŸ“– å­¦ä¹ ç‚¹ï¼šå…ˆå¤åˆ¶ package æ–‡ä»¶å†å®‰è£…ä¾èµ–
# åˆ©ç”¨ Docker ç¼“å­˜å±‚ï¼šåªè¦ package.json æ²¡å˜ï¼Œ
# npm ci è¿™ä¸€å±‚å°±ä¼šç”¨ç¼“å­˜ï¼Œä¸éœ€è¦é‡æ–°å®‰è£…
COPY package.json package-lock.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/server/package.json packages/server/

RUN npm ci --workspace=packages/shared --workspace=packages/server

# å¤åˆ¶æºç å¹¶æ„å»º
COPY packages/shared/ packages/shared/
COPY packages/server/ packages/server/
COPY tsconfig.base.json ./

RUN npm run build --workspace=packages/server 2>/dev/null || true

# ---------- ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ ----------
FROM node:22-alpine AS production

WORKDIR /app

# ğŸ“– å­¦ä¹ ç‚¹ï¼šåªå¤åˆ¶ç”Ÿäº§ä¾èµ–
COPY package.json package-lock.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/server/package.json packages/server/

RUN npm ci --workspace=packages/shared --workspace=packages/server --omit=dev

# å¤åˆ¶æºç ï¼ˆtsx ç›´æ¥è¿è¡Œ TypeScriptï¼Œæ— éœ€ç¼–è¯‘äº§ç‰©ï¼‰
COPY packages/shared/ packages/shared/
COPY packages/server/ packages/server/

# ğŸ“– å­¦ä¹ ç‚¹ï¼šCloud Run è¦æ±‚ç›‘å¬ PORT ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=8080
EXPOSE 8080

# ğŸ“– ä½¿ç”¨ tsx ç›´æ¥è¿è¡Œ TypeScript
CMD ["npx", "tsx", "packages/server/src/index.ts"]
