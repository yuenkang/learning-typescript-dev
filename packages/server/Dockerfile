# ============================================
# ğŸ“– å­¦ä¹ ç‚¹ï¼šå¤šé˜¶æ®µ Docker æ„å»ºï¼ˆMulti-stage Buildï¼‰
# ============================================
# åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼š
#   1. build é˜¶æ®µï¼šå®‰è£…å…¨éƒ¨ä¾èµ–
#   2. production é˜¶æ®µï¼šåªå®‰è£…ç”Ÿäº§ä¾èµ– + å¤åˆ¶æºç 
# è¿™æ ·æœ€ç»ˆé•œåƒæ›´å°ã€æ›´å®‰å…¨

# ---------- ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º ----------
FROM node:22-alpine AS build

WORKDIR /app

# ğŸ“– å­¦ä¹ ç‚¹ï¼šå…ˆå¤åˆ¶ package æ–‡ä»¶å†å®‰è£…ä¾èµ–
# åˆ©ç”¨ Docker ç¼“å­˜å±‚ï¼šåªè¦ package.json æ²¡å˜ï¼Œ
# npm ci è¿™ä¸€å±‚å°±ä¼šç”¨ç¼“å­˜ï¼Œä¸éœ€è¦é‡æ–°å®‰è£…
COPY package.json package-lock.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/server/package.json packages/server/

RUN npm ci --workspace=packages/shared --workspace=packages/server

# ---------- ç¬¬äºŒé˜¶æ®µï¼šè¿è¡Œ ----------
FROM node:22-alpine AS production

WORKDIR /app

# ğŸ“– å­¦ä¹ ç‚¹ï¼šåªå¤åˆ¶ç”Ÿäº§ä¾èµ–ï¼ˆtsx å·²ç§»è‡³ dependenciesï¼‰
COPY package.json package-lock.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/server/package.json packages/server/

RUN npm ci --workspace=packages/shared --workspace=packages/server --omit=dev

# å¤åˆ¶æºç 
COPY packages/shared/ packages/shared/
COPY packages/server/ packages/server/

# ğŸ“– åˆ›å»ºæ•°æ®ç›®å½•ï¼ˆSQLite æ•°æ®åº“å­˜å‚¨ä½ç½®ï¼‰
RUN mkdir -p packages/server/data

# ğŸ“– å­¦ä¹ ç‚¹ï¼šCloud Run è¦æ±‚ç›‘å¬ PORT ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=8080
EXPOSE 8080

# ğŸ“– ä½¿ç”¨ tsx ç›´æ¥è¿è¡Œ TypeScriptï¼ˆtsx å·²åœ¨ dependencies ä¸­ï¼‰
CMD ["npx", "tsx", "packages/server/src/index.ts"]
