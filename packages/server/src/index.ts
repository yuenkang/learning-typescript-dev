// ============================================
// ğŸ“– TypeScript å­¦ä¹ ç¬”è®°ï¼šExpress åç«¯å…¥å£
// ============================================
// è¿™æ˜¯åç«¯åº”ç”¨çš„å…¥å£æ–‡ä»¶ã€‚
// æ³¨æ„æ‰€æœ‰çš„å˜é‡ã€å‚æ•°ã€è¿”å›å€¼éƒ½æœ‰æ˜ç¡®çš„ç±»å‹ã€‚

// ğŸ“– å­¦ä¹ ç‚¹ï¼šES Module çš„ import è¯­æ³•
// åœ¨ TypeScript ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥ç›´æ¥ import npm åŒ…
// å› ä¸ºå®‰è£…äº† @types/expressï¼ŒTS çŸ¥é“ express çš„æ‰€æœ‰ç±»å‹
import express, { Request, Response } from "express";
import cors from "cors";

// ğŸ“– å­¦ä¹ ç‚¹ï¼šä»å…±äº«åŒ…ä¸­å¯¼å…¥ç±»å‹
// è¿™å°±æ˜¯ monorepo çš„å¥½å¤„ â€”â€” å‰åç«¯ç”¨åŒä¸€å¥—ç±»å‹å®šä¹‰
import type { ApiResponse } from "@bookmark/shared";

// ============================================
// åˆ›å»º Express åº”ç”¨
// ============================================

// ğŸ“– å­¦ä¹ ç‚¹ï¼šç±»å‹æ¨æ–­ï¼ˆType Inferenceï¼‰
// TS ä¼šè‡ªåŠ¨æ¨æ–­ app çš„ç±»å‹ä¸º Express å®ä¾‹
// ä½ ä¸éœ€è¦å†™ const app: Express = express()
const app = express();

// ğŸ“– å­¦ä¹ ç‚¹ï¼šå¸¸é‡çš„ç±»å‹
// PORT ä¼šè¢«æ¨æ–­ä¸º number ç±»å‹
// åç«¯ç›‘å¬ 3001 ç«¯å£ï¼Œå‰ç«¯ç”¨ 5173 ç«¯å£ï¼Œé¿å…å†²çª
const PORT = 3001;

// ============================================
// ä¸­é—´ä»¶é…ç½®
// ============================================

// ğŸ“– å­¦ä¹ ç‚¹ï¼šä¸­é—´ä»¶ï¼ˆMiddlewareï¼‰
// ä¸­é—´ä»¶æ˜¯åœ¨è¯·æ±‚åˆ°è¾¾è·¯ç”±å¤„ç†å™¨ä¹‹å‰æ‰§è¡Œçš„å‡½æ•°ã€‚
// ä½ å¯ä»¥æŠŠå®ƒæƒ³è±¡æˆä¸€é“"å…³å¡"ï¼Œè¯·æ±‚è¦ç»è¿‡æ‰€æœ‰ä¸­é—´ä»¶åæ‰èƒ½åˆ°è¾¾ç›®çš„åœ°ã€‚

// cors() - å…è®¸è·¨åŸŸè¯·æ±‚ï¼ˆå‰ç«¯ 5173 -> åç«¯ 3001 æ˜¯è·¨åŸŸçš„ï¼‰
app.use(cors());

// express.json() - è‡ªåŠ¨è§£æè¯·æ±‚ä½“ä¸­çš„ JSON æ•°æ®
// è§£æåçš„æ•°æ®ä¼šæ”¾åœ¨ req.body ä¸­
app.use(express.json());

// ============================================
// è·¯ç”±å®šä¹‰
// ============================================

/**
 * å¥åº·æ£€æŸ¥æ¥å£
 *
 * ğŸ“– å­¦ä¹ ç‚¹ï¼šç±»å‹æ³¨è§£ï¼ˆType Annotationï¼‰
 * - req: Request â€” Express çš„è¯·æ±‚å¯¹è±¡ç±»å‹
 * - res: Response â€” Express çš„å“åº”å¯¹è±¡ç±»å‹
 * - æˆ‘ä»¬ç”¨ ApiResponse<{ status: string; timestamp: string }> æ¥çº¦æŸå“åº”æ•°æ®
 */
app.get("/api/health", (req: Request, res: Response) => {
    // ğŸ“– å­¦ä¹ ç‚¹ï¼šå¯¹è±¡å­—é¢é‡çš„ç±»å‹
    // TypeScript ä¼šæ£€æŸ¥è¿™ä¸ªå¯¹è±¡æ˜¯å¦ç¬¦åˆ ApiResponse çš„ç»“æ„
    const response: ApiResponse<{ status: string; timestamp: string }> = {
        success: true,
        data: {
            status: "running",
            timestamp: new Date().toISOString(),
        },
        message: "ä¹¦ç­¾ç®¡ç†å™¨åç«¯æœåŠ¡è¿è¡Œæ­£å¸¸ âœ…",
    };

    res.json(response);
});

// ============================================
// å¯åŠ¨æœåŠ¡å™¨
// ============================================

app.listen(PORT, () => {
    console.log(`
  ğŸš€ ä¹¦ç­¾ç®¡ç†å™¨åç«¯å·²å¯åŠ¨
  ğŸ“ åœ°å€: http://localhost:${PORT}
  ğŸ’š å¥åº·æ£€æŸ¥: http://localhost:${PORT}/api/health
  `);
});

// ğŸ“– å­¦ä¹ ç‚¹ï¼šé»˜è®¤å¯¼å‡º
// å¯¼å‡º app å®ä¾‹ï¼Œæ–¹ä¾¿æµ‹è¯•æ—¶ä½¿ç”¨
export default app;
