// ============================================
// ðŸ“– TypeScript å­¦ä¹ ç¬”è®°ï¼šè¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
// ============================================
// ä¸­é—´ä»¶æ˜¯ Express æž¶æž„çš„æ ¸å¿ƒæ¦‚å¿µã€‚
// è¿™ä¸ªä¸­é—´ä»¶è®°å½•æ¯ä¸ª API è¯·æ±‚çš„æ–¹æ³•ã€è·¯å¾„å’Œè€—æ—¶ï¼Œ
// æ–¹ä¾¿å¼€å‘æ—¶è°ƒè¯•é—®é¢˜ã€‚
//
// ðŸ“– å­¦ä¹ ç‚¹ï¼šä¸­é—´ä»¶çš„æ‰§è¡Œæµç¨‹
// è¯·æ±‚ â†’ logger â†’ cors â†’ json â†’ è·¯ç”± â†’ errorHandler â†’ å“åº”
// logger åœ¨æœ€å‰é¢ï¼Œæ‰€ä»¥å®ƒèƒ½è®°å½•æ‰€æœ‰è¯·æ±‚

import type { Request, Response, NextFunction } from "express";

/**
 * è¯·æ±‚æ—¥å¿—ä¸­é—´ä»¶
 *
 * ðŸ“– å­¦ä¹ ç‚¹ï¼šé«˜é˜¶å‡½æ•°ï¼ˆHigher-Order Functionï¼‰
 * è¿™ä¸ªå‡½æ•°è¿”å›žä¸€ä¸ªä¸­é—´ä»¶å‡½æ•°ã€‚
 * ç”¨é«˜é˜¶å‡½æ•°çš„å¥½å¤„æ˜¯å¯ä»¥ä¼ å…¥é…ç½®å‚æ•°ï¼ˆå¦‚ optionsï¼‰ã€‚
 * è™½ç„¶è¿™é‡Œæš‚æ—¶æ²¡æœ‰å‚æ•°ï¼Œä½†é¢„ç•™äº†è¿™ä¸ªæ¨¡å¼æ–¹ä¾¿æœªæ¥æ‰©å±•ã€‚
 *
 * ðŸ“– å­¦ä¹ ç‚¹ï¼šres.on('finish', callback)
 * Express çš„ Response å¯¹è±¡ç»§æ‰¿äº† Node.js çš„ Streamã€‚
 * 'finish' äº‹ä»¶åœ¨å“åº”å‘é€å®ŒæˆåŽè§¦å‘ã€‚
 * æˆ‘ä»¬åœ¨è¿™ä¸ªæ—¶æœºè®°å½•å“åº”çŠ¶æ€ç å’Œè€—æ—¶ã€‚
 */
export function requestLogger() {
    return (req: Request, res: Response, next: NextFunction): void => {
        const startTime = Date.now();

        // ðŸ“– å­¦ä¹ ç‚¹ï¼šé¢œè‰²åŒ–çš„æŽ§åˆ¶å°è¾“å‡º
        // ANSI è½¬ä¹‰ç å¯ä»¥ç»™ç»ˆç«¯æ–‡å­—åŠ é¢œè‰²
        // \x1b[36m = é’è‰², \x1b[33m = é»„è‰², \x1b[32m = ç»¿è‰², \x1b[0m = é‡ç½®
        const method = req.method;
        const path = req.path;

        // ç›‘å¬å“åº”å®Œæˆäº‹ä»¶
        res.on("finish", () => {
            const duration = Date.now() - startTime;
            const statusCode = res.statusCode;

            // ðŸ“– å­¦ä¹ ç‚¹ï¼šæ ¹æ®çŠ¶æ€ç é€‰æ‹©é¢œè‰²
            // 2xx ç»¿è‰²ï¼ˆæˆåŠŸï¼‰ï¼Œ4xx é»„è‰²ï¼ˆå®¢æˆ·ç«¯é”™è¯¯ï¼‰ï¼Œ5xx çº¢è‰²ï¼ˆæœåŠ¡å™¨é”™è¯¯ï¼‰
            const statusColor =
                statusCode >= 500
                    ? "\x1b[31m" // çº¢
                    : statusCode >= 400
                        ? "\x1b[33m" // é»„
                        : "\x1b[32m"; // ç»¿

            console.log(
                `  ${"\x1b[36m"}${method}\x1b[0m ${path} ${statusColor}${statusCode}\x1b[0m ${duration}ms`
            );
        });

        next();
    };
}
