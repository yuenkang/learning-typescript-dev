# ============================================
# ğŸ“– å­¦ä¹ ç‚¹ï¼šé™æ€ç½‘ç«™çš„ Docker éƒ¨ç½²
# ============================================
# ç”¨ Node æ„å»º Vite é¡¹ç›®ï¼Œç„¶åç”¨ Nginx æ‰˜ç®¡é™æ€æ–‡ä»¶

# ---------- ç¬¬ä¸€é˜¶æ®µï¼šæ„å»º ----------
FROM node:22-alpine AS build

WORKDIR /app

COPY package.json package-lock.json ./
COPY packages/shared/package.json packages/shared/
COPY packages/ui/package.json packages/ui/
COPY packages/client/package.json packages/client/

RUN npm ci --workspace=packages/shared --workspace=packages/ui --workspace=packages/client

COPY packages/shared/ packages/shared/
COPY packages/ui/ packages/ui/
COPY packages/client/ packages/client/
COPY tsconfig.base.json ./

# ğŸ“– å­¦ä¹ ç‚¹ï¼šæ„å»ºæ—¶æ³¨å…¥ç¯å¢ƒå˜é‡
# ARG æ¥æ”¶ docker build --build-arg ä¼ å…¥çš„å€¼
# ç„¶åè®¾ä¸ºç¯å¢ƒå˜é‡ï¼ŒVite æ„å»ºæ—¶ä¼šé™æ€æ›¿æ¢åˆ°ä»£ç ä¸­
ARG VITE_API_BASE
ENV VITE_API_BASE=$VITE_API_BASE

RUN npm run build --workspace=packages/client

# ---------- ç¬¬äºŒé˜¶æ®µï¼šNginx æ‰˜ç®¡ ----------
FROM nginx:alpine AS production

# ğŸ“– å­¦ä¹ ç‚¹ï¼šNginx é…ç½®
# SPA åº”ç”¨éœ€è¦æŠŠæ‰€æœ‰è·¯ç”±éƒ½æŒ‡å‘ index.html
COPY packages/client/nginx.conf /etc/nginx/conf.d/default.conf

# å¤åˆ¶æ„å»ºäº§ç‰©åˆ° Nginx é»˜è®¤ç›®å½•
COPY --from=build /app/packages/client/dist /usr/share/nginx/html

# ğŸ“– Cloud Run è¦æ±‚ç›‘å¬ PORT ç¯å¢ƒå˜é‡
# Nginx é»˜è®¤ 80ï¼Œé€šè¿‡ envsubst åŠ¨æ€æ›¿æ¢
ENV PORT=8080
EXPOSE 8080

CMD ["sh", "-c", "sed -i \"s/listen 80/listen $PORT/g\" /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"]
