# ============================================
# ğŸ“– å­¦ä¹ ç‚¹ï¼šGitHub Actions CI å·¥ä½œæµ
# ============================================
# ğŸ“– CIï¼ˆContinuous Integrationï¼ŒæŒç»­é›†æˆï¼‰
# æ¯æ¬¡æ¨é€ä»£ç æˆ–åˆ›å»º PR æ—¶è‡ªåŠ¨è¿è¡Œæ£€æŸ¥ï¼Œ
# ç¡®ä¿ä»£ç è´¨é‡ï¼ˆç±»å‹å®‰å…¨ã€æ„å»ºé€šè¿‡ï¼‰

name: CI

# ğŸ“– å­¦ä¹ ç‚¹ï¼šè§¦å‘æ¡ä»¶
# push: æ¨é€åˆ° master åˆ†æ”¯æ—¶è§¦å‘
# pull_request: åˆ›å»º/æ›´æ–° PR åˆ° master æ—¶è§¦å‘
on:
  push:
    branches: [master]
  pull_request:
    branches: [master]

jobs:
  # ğŸ“– å­¦ä¹ ç‚¹ï¼šJob â€” ä¸€ç»„åœ¨åŒä¸€è¿è¡Œå™¨ä¸Šæ‰§è¡Œçš„æ­¥éª¤
  typecheck-and-build:
    name: ç±»å‹æ£€æŸ¥ & æ„å»º
    runs-on: ubuntu-latest

    steps:
      # ğŸ“– å­¦ä¹ ç‚¹ï¼šactions/checkout â€” æ‹‰å–ä»“åº“ä»£ç 
      - uses: actions/checkout@v4

      # ğŸ“– å­¦ä¹ ç‚¹ï¼šactions/setup-node â€” å®‰è£… Node.js
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      # ğŸ“– å­¦ä¹ ç‚¹ï¼šnpm ci æ¯” npm install æ›´å¿«æ›´ä¸¥æ ¼
      # å®ƒä¸¥æ ¼æŒ‰ç…§ package-lock.json å®‰è£…ï¼Œé€‚åˆ CI ç¯å¢ƒ
      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # ğŸ“– TypeScript ç±»å‹æ£€æŸ¥ â€” åˆ†åˆ«æ£€æŸ¥æ¯ä¸ªåŒ…
      - name: ç±»å‹æ£€æŸ¥ - shared
        run: npx tsc --noEmit -p packages/shared/tsconfig.json

      - name: ç±»å‹æ£€æŸ¥ - ui
        run: npx tsc --noEmit -p packages/ui/tsconfig.json

      - name: ç±»å‹æ£€æŸ¥ - server
        run: npx tsc --noEmit -p packages/server/tsconfig.json

      - name: ç±»å‹æ£€æŸ¥ - client
        run: npx tsc --noEmit -p packages/client/tsconfig.app.json

      - name: ç±»å‹æ£€æŸ¥ - desktop
        run: npx tsc --noEmit -p packages/desktop/tsconfig.app.json

      # ğŸ“– æ„å»ºéªŒè¯ â€” ç¡®ä¿ Vite èƒ½æ­£å¸¸æ„å»ºç”Ÿäº§ç‰ˆæœ¬
      - name: æ„å»º client
        run: npm run build --workspace=packages/client

      - name: æ„å»º desktop (Vite only)
        run: npm run build --workspace=packages/desktop
