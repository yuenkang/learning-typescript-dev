# ============================================
# ğŸ“– å­¦ä¹ ç‚¹ï¼šGitHub Actions CD â€” æ¡Œé¢åº”ç”¨å‘å¸ƒ
# ============================================
# ğŸ“– CDï¼ˆContinuous Deliveryï¼ŒæŒç»­äº¤ä»˜ï¼‰
# å½“æ¨é€ tagï¼ˆå¦‚ v1.0.0ï¼‰æ—¶ï¼Œè‡ªåŠ¨åœ¨ä¸‰ä¸ªå¹³å°ä¸Š
# æ‰“åŒ… Electron åº”ç”¨å¹¶åˆ›å»º GitHub Release

name: Desktop Release

# ğŸ“– å­¦ä¹ ç‚¹ï¼štag è§¦å‘
# åªåœ¨æ¨é€ v* æ ¼å¼çš„ tag æ—¶è§¦å‘ï¼ˆå¦‚ v1.0.0ã€v2.1.3ï¼‰
on:
  push:
    tags:
      - "v*"

# ğŸ“– å­¦ä¹ ç‚¹ï¼šæƒé™å£°æ˜
# GITHUB_TOKEN é»˜è®¤åªæœ‰è¯»æƒé™ï¼Œåˆ›å»º Release éœ€è¦å†™æƒé™
permissions:
  contents: write

jobs:
  release:
    name: å‘å¸ƒ ${{ matrix.os }}
    # ğŸ“– å­¦ä¹ ç‚¹ï¼šçŸ©é˜µç­–ç•¥ï¼ˆMatrix Strategyï¼‰
    # åŒä¸€ä¸ª job åœ¨å¤šä¸ªæ“ä½œç³»ç»Ÿä¸Šå¹¶è¡Œè¿è¡Œ
    # æ¯ä¸ª os ä¼šç”Ÿæˆå¯¹åº”å¹³å°çš„å®‰è£…åŒ…
    strategy:
      # ğŸ“– å­¦ä¹ ç‚¹ï¼šfail-fast: false
      # é»˜è®¤ä¸€ä¸ªå¹³å°å¤±è´¥ä¼šå–æ¶ˆæ‰€æœ‰å¹³å°ï¼Œè®¾ä¸º false è®©å„å¹³å°ç‹¬ç«‹è¿è¡Œ
      fail-fast: false
      matrix:
        os: [macos-latest, windows-latest, ubuntu-latest]
    runs-on: ${{ matrix.os }}
    # ğŸ“– è¶…æ—¶è®¾ç½®ï¼Œé˜²æ­¢æ‰“åŒ…è¿‡ç¨‹å¡æ­»
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: npm

      - name: å®‰è£…ä¾èµ–
        run: npm ci

      # ğŸ“– å­¦ä¹ ç‚¹ï¼šLinux éœ€è¦é¢å¤–çš„ç³»ç»Ÿä¾èµ–æ¥æ‰“åŒ… AppImage
      - name: å®‰è£… Linux æ‰“åŒ…ä¾èµ–
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y libarchive-tools rpm

      # ğŸ“– å­¦ä¹ ç‚¹ï¼šelectron-builder ä¼šè‡ªåŠ¨æ£€æµ‹å½“å‰ OS å¹¶æ‰“åŒ…å¯¹åº”æ ¼å¼
      # macOS â†’ .dmg + .zip
      # Windows â†’ .exe (NSIS)
      # Linux â†’ .AppImage
      - name: æ‰“åŒ…æ¡Œé¢åº”ç”¨
        run: npm run dist:desktop
        env:
          # ğŸ“– å­¦ä¹ ç‚¹ï¼šVite ç¯å¢ƒå˜é‡æ³¨å…¥
          # VITE_ å‰ç¼€çš„å˜é‡ä¼šè¢« Vite åœ¨æ„å»ºæ—¶é™æ€æ›¿æ¢åˆ°ä»£ç ä¸­
          # åœ¨ GitHub repo Settings â†’ Secrets ä¸­é…ç½® API_BASE_URL
          VITE_API_BASE: ${{ secrets.API_BASE_URL }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ğŸ“– å­¦ä¹ ç‚¹ï¼šä¸Šä¼ æ„å»ºäº§ç‰©åˆ° GitHub Release
      - name: ä¸Šä¼ åˆ° Release
        uses: softprops/action-gh-release@v2
        with:
          files: |
            packages/desktop/release/**/*.dmg
            packages/desktop/release/**/*.zip
            packages/desktop/release/**/*.exe
            packages/desktop/release/**/*.AppImage
          draft: true
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
